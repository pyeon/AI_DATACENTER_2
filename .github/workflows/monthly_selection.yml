name: ğŸ” Monthly Stock Selection

on:
  schedule:
    # ë§¤ì›” 1ì¼ í•œêµ­ì‹œê°„ 10:00
    # UTC 01:00 = í•œêµ­ì‹œê°„ 10:00
    - cron: '0 1 1 * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:

jobs:
  monthly-selection:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v5
      
      - name: ğŸ Python 3.10 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“‚ ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
        run: mkdir -p outputs
      
      - name: ğŸ” ì¢…ëª© ì„ ì • ì‹¤í–‰
        run: |
          python scripts/stock_selection_system.py | tee selection_output.txt
      
      - name: ğŸ“ ê²°ê³¼ íŒŒì¼ ì—…ë¡œë“œ (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: stock-selection-${{ github.run_number }}
          path: |
            outputs/selected_stocks_*.xlsx
            selection_output.txt
          retention-days: 90
      
      - name: ğŸ“ Issue ìƒì„± (ì„ ì • ê²°ê³¼ ì•Œë¦¼)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            
            // ì„ ì • ê²°ê³¼ í…ìŠ¤íŠ¸ ì½ê¸°
            let outputText = '';
            try {
              outputText = fs.readFileSync('selection_output.txt', 'utf8');
              // STOCKS ë¦¬ìŠ¤íŠ¸ ë¶€ë¶„ ì¶”ì¶œ
              const stocksMatch = outputText.match(/STOCKS = \[([\s\S]*?)\]/);
              const stocksList = stocksMatch ? stocksMatch[0] : 'ë¡œê·¸ì—ì„œ STOCKS ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”';
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“Š ${date} ì›”ê°„ ì¢…ëª© ì„ ì • ì™„ë£Œ`,
                body: `
## ğŸ¯ ì›”ê°„ ì¢…ëª© ì„ ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
- [Actions ì‹¤í–‰ ê²°ê³¼](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ì—ì„œ Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ

### ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„
1. **Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ê²€í† **
   - Artifactsì—ì„œ \`selected_stocks_*.xlsx\` ë‹¤ìš´ë¡œë“œ
   - ê° ì„¸ë¶€ì˜ì—­ë³„ ì„ ì • ì¢…ëª© ë° ì ìˆ˜ í™•ì¸

2. **STOCKS ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸**
   \`\`\`python
   ${stocksList}
   \`\`\`

3. **ì½”ë“œ ì—…ë°ì´íŠ¸**
   - \`scripts/datacenter_report_enhanced.py\` íŒŒì¼ ì—´ê¸°
   - STOCKS ë³€ìˆ˜ë¥¼ ìœ„ ë¦¬ìŠ¤íŠ¸ë¡œ êµì²´
   - ì»¤ë°‹ ë° í‘¸ì‹œ

### ğŸ“… ë‹¤ìŒ ì‹¤í–‰
- **ë‹¤ìŒ ë‹¬ 1ì¼** ìë™ ì‹¤í–‰ ì˜ˆì •
- ìˆ˜ë™ ì‹¤í–‰: Actions â†’ Monthly Stock Selection â†’ Run workflow

### ğŸ“Š ì°¸ê³ 
- ì ìˆ˜ ê¸°ì¤€: ì‹œê°€ì´ì•¡(30ì ) + ê±°ë˜ëŸ‰(20ì ) + 3ê°œì›”ìˆ˜ìµë¥ (20ì ) + 6ê°œì›”ìˆ˜ìµë¥ (15ì ) + ê¸°ìˆ ì ì§€í‘œ(15ì )
- ê° ì„¸ë¶€ì˜ì—­ë³„ ìµœê³  ì ìˆ˜ ì¢…ëª© ìë™ ì„ ì •
                `
              });
              
              console.log('âœ… Issue ìƒì„± ì™„ë£Œ');
            } catch (error) {
              console.log('âš ï¸ Issue ìƒì„± ì‹¤íŒ¨:', error.message);
              console.log('Artifactsì—ì„œ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥');
            }
      
      - name: âœ… ì™„ë£Œ
        run: |
          echo "âœ… ì¢…ëª© ì„ ì • ì™„ë£Œ!"
          echo "ğŸ“ Artifactsì—ì„œ Excel ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥"
          echo "ğŸ“‹ Issueê°€ ìƒì„±ë˜ì–´ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤"
